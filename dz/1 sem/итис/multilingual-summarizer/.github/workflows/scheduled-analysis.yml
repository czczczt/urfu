name: Scheduled Weekly Analysis

on:
  schedule:
    # Каждый понедельник в 10:00 UTC
    - cron: '0 10 * * 1'
  # Позволяет запускать вручную
  workflow_dispatch:
    inputs:
      compression_ratio:
        description: 'Compression ratio (0.1-0.9)'
        required: false
        default: '0.3'

jobs:
  analysis:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run analysis and generate report
      env:
        COMPRESSION_RATIO: ${{ inputs.compression_ratio || '0.3' }}
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from src.summarizer import TextSummarizer
        from datetime import datetime
        
        summarizer = TextSummarizer()
        
        # Читаем sample текст из CSV или текстового файла
        text = '''Machine learning is a subset of artificial intelligence. 
        It focuses on developing programs that can learn from experience. 
        Machine learning algorithms are very powerful. 
        They work best with large datasets.'''
        
        try:
            import pandas as pd
            df = pd.read_csv('data/sample.csv')
            if not df.empty:
                text = df['text'].iloc[0]
        except:
            try:
                with open('data/sample.txt', 'r', encoding='utf-8') as f:
                    text = f.read()
            except:
                pass
        
        compression = float('${{ env.COMPRESSION_RATIO }}')
        summary = summarizer.summarize(text, compression_ratio=compression)
        keywords = summarizer.get_key_words(text, n_words=5)
        
        report = f'''{'='*60}
WEEKLY ANALYSIS REPORT
{'='*60}

Compression ratio used: {compression*100:.0f}%
Original text length: {len(text)} characters
Summary length: {len(summary)} characters
Reduction: {(1-len(summary)/len(text))*100:.1f}%

{'='*60}
SUMMARY:
{'='*60}
{summary}

{'='*60}
KEYWORDS:
{'='*60}
{', '.join(keywords)}

{'='*60}
Analysis completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
{'='*60}
'''
        print(report)
        " > analysis_report.txt
    
    - name: Upload analysis results
      uses: actions/upload-artifact@v3
      with:
        name: weekly-analysis
        path: analysis_report.txt
        retention-days: 30
    
    - name: Commit results to repo
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add analysis_report.txt || true
        git commit -m "Weekly analysis update - $(date +'%Y-%m-%d %H:%M:%S')" || true
        git push || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    runs-on: ubuntu-latest
    needs: analysis
    if: always()
    steps:
    - name: Notify completion
      run: echo "Weekly analysis workflow completed successfully!"
