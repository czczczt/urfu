"""
–ú–æ–¥—É–ª—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ GigaChat –ò–ò –º–æ–¥–µ–ª–∏
"""
from gigachat import GigaChat
from config import (
    GIGACHAT_CREDENTIALS, 
    GIGACHAT_SCOPE, 
    GIGACHAT_MODEL,
    GIGACHAT_MAX_TOKENS_SEARCH,
    GIGACHAT_MAX_TOKENS_RESPONSE,
    GIGACHAT_MAX_TOKENS_ANALYSIS
)
from typing import Optional, List, Dict
import asyncio
import json
import re
from datetime import datetime, timedelta


# –ö–∞—Ä—Ç–∞ —Ä–∞–π–æ–Ω–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏
DISTRICT_MAPPING = {
    "–º–æ—Å–∫–≤–∞": {
        "—Ü–µ–Ω—Ç—Ä": ["–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π", "–¢–≤–µ—Ä—Å–∫–æ–π", "–ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π", "–ê—Ä–±–∞—Ç", "–•–∞–º–æ–≤–Ω–∏–∫–∏", "–ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ"],
        "–¥–µ–ª–æ–≤–æ–π_—Ü–µ–Ω—Ç—Ä": ["–ú–æ—Å–∫–≤–∞-–°–∏—Ç–∏", "–ü—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π", "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π", "–¢–≤–µ—Ä—Å–∫–æ–π"],
        "–æ–∫—Ä–∞–∏–Ω—ã": ["–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥", "–ù–æ–≤–æ–∫–æ—Å–∏–Ω–æ", "–ú–∏—Ç–∏–Ω–æ", "–°–æ–ª–Ω—Ü–µ–≤–æ", "–Æ–∂–Ω–æ–µ –ë—É—Ç–æ–≤–æ", "–°–µ–≤–µ—Ä–Ω–æ–µ –ë—É—Ç–æ–≤–æ"],
        "—Å–µ–≤–µ—Ä": ["–°–µ–≤–µ—Ä–Ω—ã–π", "–ì–æ–ª–æ–≤–∏–Ω—Å–∫–∏–π", "–í–æ–π–∫–æ–≤—Å–∫–∏–π"],
        "—é–≥": ["–Æ–∂–Ω—ã–π", "–ß–µ—Ä—Ç–∞–Ω–æ–≤–æ", "–ë–∏—Ä—é–ª—ë–≤–æ"],
        "–≤–æ—Å—Ç–æ–∫": ["–í–æ—Å—Ç–æ—á–Ω—ã–π", "–ò–∑–º–∞–π–ª–æ–≤–æ", "–ü–µ—Ä–æ–≤–æ"],
        "–∑–∞–ø–∞–¥": ["–ó–∞–ø–∞–¥–Ω—ã–π", "–ö—É–Ω—Ü–µ–≤–æ", "–§–∏–ª–∏"]
    },
    "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": {
        "—Ü–µ–Ω—Ç—Ä": ["–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π", "–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π", "–ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π"],
        "–¥–µ–ª–æ–≤–æ–π_—Ü–µ–Ω—Ç—Ä": ["–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π", "–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π"],
        "–æ–∫—Ä–∞–∏–Ω—ã": ["–ö—É—Ä–æ—Ä—Ç–Ω—ã–π", "–ü—É—à–∫–∏–Ω—Å–∫–∏–π", "–ö–æ–ª–ø–∏–Ω—Å–∫–∏–π"],
        "—Å–µ–≤–µ—Ä": ["–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π", "–í—ã–±–æ—Ä–≥—Å–∫–∏–π"],
        "—é–≥": ["–ú–æ—Å–∫–æ–≤—Å–∫–∏–π", "–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π"],
        "–≤–æ—Å—Ç–æ–∫": ["–ù–µ–≤—Å–∫–∏–π", "–ö—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π"],
        "–∑–∞–ø–∞–¥": ["–ö–∏—Ä–æ–≤—Å–∫–∏–π", "–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π"]
    },
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": {
        "—Ü–µ–Ω—Ç—Ä": ["–õ–µ–Ω–∏–Ω—Å–∫–∏–π"],
        "–¥–µ–ª–æ–≤–æ–π_—Ü–µ–Ω—Ç—Ä": ["–õ–µ–Ω–∏–Ω—Å–∫–∏–π", "–í–µ—Ä—Ö-–ò—Å–µ—Ç—Å–∫–∏–π"],
        "–æ–∫—Ä–∞–∏–Ω—ã": ["–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π", "–ß–∫–∞–ª–æ–≤—Å–∫–∏–π"],
        "—Å–µ–≤–µ—Ä": ["–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π"],
        "—é–≥": ["–ß–∫–∞–ª–æ–≤—Å–∫–∏–π"],
        "–≤–æ—Å—Ç–æ–∫": ["–û—Ä–¥–∂–æ–Ω–∏–∫–∏–¥–∑–µ–≤—Å–∫–∏–π"],
        "–∑–∞–ø–∞–¥": ["–í–µ—Ä—Ö-–ò—Å–µ—Ç—Å–∫–∏–π"]
    },
    "—á–µ–ª—è–±–∏–Ω—Å–∫": {
        "—Ü–µ–Ω—Ç—Ä": ["–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π", "–°–æ–≤–µ—Ç—Å–∫–∏–π"],
        "–¥–µ–ª–æ–≤–æ–π_—Ü–µ–Ω—Ç—Ä": ["–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π"],
        "–æ–∫—Ä–∞–∏–Ω—ã": ["–ú–µ—Ç–∞–ª–ª—É—Ä–≥–∏—á–µ—Å–∫–∏–π", "–¢—Ä–∞–∫—Ç–æ—Ä–æ–∑–∞–≤–æ–¥—Å–∫–∏–π", "–õ–µ–Ω–∏–Ω—Å–∫–∏–π"],
        "—Å–µ–≤–µ—Ä": ["–ú–µ—Ç–∞–ª–ª—É—Ä–≥–∏—á–µ—Å–∫–∏–π", "–ö—É—Ä—á–∞—Ç–æ–≤—Å–∫–∏–π"],
        "—é–≥": ["–°–æ–≤–µ—Ç—Å–∫–∏–π", "–õ–µ–Ω–∏–Ω—Å–∫–∏–π"],
        "–≤–æ—Å—Ç–æ–∫": ["–¢—Ä–∞–∫—Ç–æ—Ä–æ–∑–∞–≤–æ–¥—Å–∫–∏–π"],
        "–∑–∞–ø–∞–¥": ["–ö–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π", "–ö—É—Ä—á–∞—Ç–æ–≤—Å–∫–∏–π"]
    }
}


class AIService:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GigaChat –ò–ò –º–æ–¥–µ–ª—å—é"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ò–ò —Å–µ—Ä–≤–∏—Å–∞"""
        if GIGACHAT_CREDENTIALS:
            try:
                # –û—á–∏—â–∞–µ–º credentials –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
                clean_credentials = GIGACHAT_CREDENTIALS.strip()
                
                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –≤–º–µ—Å—Ç–µ —Å "Basic ", —É–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
                if clean_credentials.startswith("Basic "):
                    clean_credentials = clean_credentials[6:].strip()
                    print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–µ—Ñ–∏–∫—Å 'Basic ' –≤ GIGACHAT_CREDENTIALS. –û–Ω –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω.")
                
                # –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ —Å–ª—É—á–∞–π–Ω–æ –ø–æ–ø–∞–ª–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏–µ
                clean_credentials = clean_credentials.strip("'").strip('"')

                self.giga = GigaChat(
                    credentials=clean_credentials,
                    scope=GIGACHAT_SCOPE,
                    model=GIGACHAT_MODEL,
                    verify_ssl_certs=False,
                    timeout=60
                )
                self.gigachat_available = True
            except Exception as e:
                self.gigachat_available = False
                print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {str(e)}")
        else:
            self.gigachat_available = False
            print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: GIGACHAT_CREDENTIALS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò–ò —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.")
    
    async def extract_search_parameters(self, user_prompt: str, current_city: str = None) -> Dict:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—á—ë—Ç–æ–º –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏,
        –æ—Ç—Ä–∏—Ü–∞–Ω–∏–π, –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤.
        
        Args:
            user_prompt: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            current_city: –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
            
        Returns:
            –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–∏—Å–∫–∞, –≤–∫–ª—é—á–∞—è –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—è:
            - –ë–∞–∑–æ–≤—ã–µ: city, district, area_min, area_max, budget, floor
            - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ: excluded_districts, excluded_floors, priority, urgency, 
                        accessibility, is_strict, deal_type, renovation_status,
                        parking, entrance_type
        """
        if not self.gigachat_available:
            return {}
            
        try:
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –¥–ª—è GigaChat
            system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∞—Ä–µ–Ω–¥—É/–ø–æ–∫—É–ø–∫—É –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π.

–ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê –û–ë–†–ê–ë–û–¢–ö–ò:

1. –ì–ï–û–ì–†–ê–§–ò–Ø - –ñ–Å–°–¢–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
   - –¶–µ–Ω—Ç—Ä ("—Ü–µ–Ω—Ç—Ä", "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π", "–≤ —Ü–µ–Ω—Ç—Ä–µ", "downtown"):
     * –ú–æ—Å–∫–≤–∞ ‚Üí district: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π"
     * –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ ‚Üí district: "–õ–µ–Ω–∏–Ω—Å–∫–∏–π"
     * –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ ‚Üí district: "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π"
   
   - –û–∫—Ä–∞–∏–Ω—ã/–∫—Ä–∞–π ("–Ω–∞ –∫—Ä–∞—é", "–æ–∫—Ä–∞–∏–Ω—ã", "–Ω–∞ –æ–∫—Ä–∞–∏–Ω–µ", "–æ–∫—Ä–∞–∏–Ω–Ω—ã–π —Ä–∞–π–æ–Ω"):
     * –ú–æ—Å–∫–≤–∞ ‚Üí district: ["–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥", "–ù–æ–≤–æ–∫–æ—Å–∏–Ω–æ", "–ú–∏—Ç–∏–Ω–æ", "–°–æ–ª–Ω—Ü–µ–≤–æ"]
     * –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ ‚Üí district: ["–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π", "–ß–∫–∞–ª–æ–≤—Å–∫–∏–π"]
     * –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ ‚Üí district: ["–ö—É—Ä–æ—Ä—Ç–Ω—ã–π", "–ü—É—à–∫–∏–Ω—Å–∫–∏–π", "–ö–æ–ª–ø–∏–Ω—Å–∫–∏–π"]
     * –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –í–°–ï –æ–∫—Ä–∞–∏–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–æ–∫ –∏–∑ mapping
   
   - –ò—Å–∫–ª—é—á–µ–Ω–∏—è ("–Ω–µ –æ–∫—Ä–∞–∏–Ω—ã", "–∫—Ä–æ–º–µ –æ–∫—Ä–∞–∏–Ω", "–±–µ–∑ –æ–∫—Ä–∞–∏–Ω", "–Ω–µ –≤ —Ü–µ–Ω—Ç—Ä–µ"):
     * "–Ω–µ –æ–∫—Ä–∞–∏–Ω—ã" ‚Üí –∏—Å–∫–ª—é—á–∏ –æ–∫—Ä–∞–∏–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã –∏–∑ excluded_districts
     * "–Ω–µ –≤ —Ü–µ–Ω—Ç—Ä–µ" ‚Üí –∏—Å–∫–ª—é—á–∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ —Ä–∞–π–æ–Ω—ã –∏–∑ excluded_districts
   
   - –ú–µ—Ç—Ä–æ ("—É –º–µ—Ç—Ä–æ", "—Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ", "–≤–æ–∑–ª–µ —Å—Ç–∞–Ω—Ü–∏–∏") = –≤ accessibility
   - –î–µ–ª–æ–≤—ã–µ –∑–æ–Ω—ã ("–¥–µ–ª–æ–≤–æ–π", "–±–∏–∑–Ω–µ—Å", "–°–∏—Ç–∏", "–æ—Ñ–∏—Å–Ω—ã–π —Ü–µ–Ω—Ç—Ä") = district: "–î–µ–ª–æ–≤–æ–π"
   - –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –†–ê–ô–û–ù–´: –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç–æ 2+ —Ä–∞–π–æ–Ω–∞ ("X –∏ Y", "X –∏–ª–∏ Y", "—Ç–∞–∫–∂–µ X", "–µ—â—ë Y") ‚Üí district: ["X", "Y"]

2. –û–¢–†–ò–¶–ê–ù–ò–Ø –ò –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø:
   - –õ—é–±—ã–µ "–ù–ï", "–ë–ï–ó", "–ö–†–û–ú–ï", "–ò–°–ö–õ–Æ–ß–ê–Ø" ‚Üí –≤ excluded_* –ø–æ–ª—è
   - –≠—Ç–∞–∂–∏ ("–Ω–µ –ø–µ—Ä–≤—ã–π", "–Ω–µ –Ω–∞ –ø–µ—Ä–≤–æ–º", "–±–µ–∑ –ø–µ—Ä–≤–æ–≥–æ") ‚Üí excluded_floors: [1]
   - –ü–æ–¥–≤–∞–ª/—Ü–æ–∫–æ–ª—å ("–±–µ–∑ –ø–æ–¥–≤–∞–ª–∞", "–Ω–µ —Ü–æ–∫–æ–ª—å") ‚Üí excluded_floors: ["–ø–æ–¥–≤–∞–ª", "—Ü–æ–∫–æ–ª—å–Ω—ã–π", -1, 0]

3. –ü–õ–û–©–ê–î–¨ - –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê:
   –ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –û–î–ù–û —á–∏—Å–ª–æ –ë–ï–ó –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∏ –ë–ï–ó —Å–ª–æ–≤ "—Å—Ç—Ä–æ–≥–æ/—Ä–æ–≤–Ω–æ/—Ç–æ—á–Ω–æ" ‚Üí –¥–æ–±–∞–≤—å ¬±20%!
   
   –ü—Ä–∏–º–µ—Ä—ã:
   - "–ø–ª–æ—â–∞–¥—å 1000", "–Ω—É–∂–Ω–æ 1000 –º–µ—Ç—Ä–æ–≤", "1000 –º¬≤", "—Ç—ã—Å—è—á–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤" ‚Üí area_min: 800, area_max: 1200
   - "50 –∫–≤–∞–¥—Ä–∞—Ç–æ–≤", "–ø–ª–æ—â–∞–¥—å—é 50", "–º–µ—Ç—Ä–æ–≤ 50" ‚Üí area_min: 40, area_max: 60
   - "200 –º¬≤" ‚Üí area_min: 160, area_max: 240
   
   –î–∏–∞–ø–∞–∑–æ–Ω—ã (–æ—Å—Ç–∞–≤–ª—è–π –∫–∞–∫ –µ—Å—Ç—å):
   - "–æ—Ç 50 –¥–æ 100", "50-100", "–º–µ–∂–¥—É 50 –∏ 100" ‚Üí area_min: 50, area_max: 100
   - "–æ—Ç 200", "–º–∏–Ω–∏–º—É–º 200", "–Ω–µ –º–µ–Ω—å—à–µ 200" ‚Üí area_min: 200, area_max: null
   - "–¥–æ 100", "–º–∞–∫—Å–∏–º—É–º 100", "–Ω–µ –±–æ–ª—å—à–µ 100" ‚Üí area_min: null, area_max: 100
   
   –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:
   - "–æ–∫–æ–ª–æ", "–ø—Ä–∏–º–µ—Ä–Ω–æ", "–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ" + —á–∏—Å–ª–æ ‚Üí ¬±15% –æ—Ç —á–∏—Å–ª–∞
   - "—Å—Ç—Ä–æ–≥–æ", "—Ä–æ–≤–Ω–æ", "—Ç–æ—á–Ω–æ", "–∏–º–µ–Ω–Ω–æ" + —á–∏—Å–ª–æ ‚Üí ¬±2% –æ—Ç —á–∏—Å–ª–∞, is_strict: true

4. –ë–Æ–î–ñ–ï–¢:
   - –§–æ—Ä–º–∞—Ç—ã: "200000", "200 —Ç—ã—Å", "200–∫", "200 —Ç—ã—Å—è—á", "200000 —Ä—É–±–ª–µ–π"
   - "–¥–æ 200–∫", "–º–∞–∫—Å–∏–º—É–º 200–∫", "–Ω–µ –±–æ–ª—å—à–µ 200–∫" ‚Üí budget_min: null, budget_max: 200000
   - "–æ—Ç 100–∫", "–º–∏–Ω–∏–º—É–º 100–∫" ‚Üí budget_min: 100000, budget_max: null
   - "–æ—Ç 100 –¥–æ 200–∫", "100-200 —Ç—ã—Å—è—á" ‚Üí budget_min: 100000, budget_max: 200000
   - "–æ–∫–æ–ª–æ 200–∫" ‚Üí budget_min: 170000, budget_max: 230000 (¬±15%)

5. –ü–†–ò–û–†–ò–¢–ï–¢–´:
   - –£–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞/–ª–æ–∫–∞—Ü–∏–∏ ‚Üí priority: "location"
   - "–≥–ª–∞–≤–Ω–æ–µ —Ü–µ–Ω–∞", "–±—é–¥–∂–µ—Ç –≤–∞–∂–µ–Ω", "–Ω–µ –ø–µ—Ä–µ–ø–ª–∞—Ç–∏—Ç—å" ‚Üí priority: "price"
   - "–≥–ª–∞–≤–Ω–æ–µ –ø–ª–æ—â–∞–¥—å", "–º–Ω–æ–≥–æ –º–µ—Å—Ç–∞" ‚Üí priority: "area"
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Üí priority: "balanced"

6. –°–†–û–ß–ù–û–°–¢–¨:
   - "—Å—Ä–æ—á–Ω–æ", "—Å–µ–≥–æ–¥–Ω—è", "—Å–µ–π—á–∞—Å", "–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ" ‚Üí urgency: 9-10
   - "—Å–∫–æ—Ä–æ", "–≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è", "–Ω–∞ –¥–Ω—è—Ö" ‚Üí urgency: 6-8
   - "–Ω–µ —Å–ø–µ—à—É", "–ø—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å", "–≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ" ‚Üí urgency: 1-3
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Üí urgency: 5

7. –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–õ–£–ß–ê–ò:
   - –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ —É–ø–æ–º—è–Ω—É—Ç ‚Üí null
   - –ï—Å–ª–∏ —è–≤–Ω–æ —Å–∫–∞–∑–∞–Ω–æ "–Ω–µ –≤–∞–∂–Ω–æ", "–ª—é–±–æ–π", "—É–±–µ—Ä–∏ —Ñ–∏–ª—å—Ç—Ä", "—Å–±—Ä–æ—Å—å" –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ‚Üí "RESET"
   - "–ø–ª–æ—â–∞–¥—å –Ω–µ –≤–∞–∂–Ω–∞" ‚Üí area_min: "RESET", area_max: "RESET"
   - "–±—é–¥–∂–µ—Ç –Ω–µ –≤–∞–∂–µ–Ω" ‚Üí budget_min: "RESET", budget_max: "RESET"
   - "–≥–æ—Ä–æ–¥ –Ω–µ –≤–∞–∂–µ–Ω" ‚Üí city: "RESET"

8. –û–ü–ï–†–ê–¶–ò–ò –° –†–ê–ô–û–ù–ê–ú–ò:
   - district_operation:
     * "add" - –µ—Å–ª–∏ –µ—Å—Ç—å —Å–ª–æ–≤–∞ "–¥–æ–±–∞–≤—å", "–µ—â—ë", "—Ç–∞–∫–∂–µ", "–ø–ª—é—Å", "–∏" (–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
     * "replace" - –µ—Å–ª–∏ "—Ç–æ–ª—å–∫–æ", "–≤–º–µ—Å—Ç–æ", "–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ", "—Å—Ç—Ä–æ–≥–æ", –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω –Ω–æ–≤—ã–π —Ä–∞–π–æ–Ω –±–µ–∑ —Å–ª–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: –¢–û–õ–¨–ö–û JSON, –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ì–û –¢–ï–ö–°–¢–ê –ò MARKDOWN."""

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≥–æ—Ä–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω –∏–∑–≤–µ—Å—Ç–µ–Ω
            city_context = ""
            if current_city:
                city_context = f"\n–í–ê–ñ–ù–û: –¢–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥ –ø–æ–∏—Å–∫–∞ - {current_city}. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–π–æ–Ω, –∏—â–∏ –µ–≥–æ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ. –ú–µ–Ω—è–π –≥–æ—Ä–æ–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ø–í–ù–û –ø—Ä–æ—Å–∏—Ç –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥."

            user_content = f"""–ò–∑–≤–ª–µ–∫–∏ –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.{city_context}

–ó–∞–ø—Ä–æ—Å: "{user_prompt}"

–í–µ—Ä–Ω–∏ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏ (–µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ —É–ø–æ–º—è–Ω—É—Ç - null):

{{
  "city": "–Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ null",
  "district": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ –∏–ª–∏ –º–∞—Å—Å–∏–≤ —Ä–∞–π–æ–Ω–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ",
  "district_operation": "add" | "replace",
  "area_min": —á–∏—Å–ª–æ –∏–ª–∏ null,
  "area_max": —á–∏—Å–ª–æ –∏–ª–∏ null,
  "budget_min": —á–∏—Å–ª–æ –∏–ª–∏ null,
  "budget_max": —á–∏—Å–ª–æ –∏–ª–∏ null,
  "floor": —á–∏—Å–ª–æ –∏–ª–∏ null,
  
  "excluded_districts": ["—Å–ø–∏—Å–æ–∫", "—Ä–∞–π–æ–Ω–æ–≤", "–¥–ª—è", "–∏—Å–∫–ª—é—á–µ–Ω–∏—è"] –∏–ª–∏ [],
  "excluded_floors": [—Å–ø–∏—Å–æ–∫_—ç—Ç–∞–∂–µ–π_–¥–ª—è_–∏—Å–∫–ª—é—á–µ–Ω–∏—è] –∏–ª–∏ [],
  "priority": "location" | "price" | "area" | "balanced",
  "urgency": —á–∏—Å–ª–æ_–æ—Ç_1_–¥–æ_10,
  "accessibility": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–º–µ—Ç—Ä–æ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç)" –∏–ª–∏ null,
  "is_strict": true_–µ—Å–ª–∏_–∂—ë—Å—Ç–∫–∏–µ_—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–ª–∏ false,
  
  "deal_type": "rent" | "sale" | null,
  "renovation_status": "ready" | "rough" | "any" | null,
  "parking": true | false | null,
  "entrance_type": "separate" | "common" | null
}}

–ü–†–ò–ú–ï–†–´:

–ó–∞–ø—Ä–æ—Å: "–ù—É–∂–Ω–æ –ø–æ–º–µ—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ —Ü–µ–Ω—Ç—Ä–µ –ú–æ—Å–∫–≤—ã, –¥–æ 200 —Ç—ã—Å—è—á, –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é –æ–∫—Ä–∞–∏–Ω—ã"
{{
  "city": "–ú–æ—Å–∫–≤–∞",
  "district": "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π",
  "district_operation": "replace",
  "area_min": null,
  "area_m_min": null,
  "budget_maxax": null,
  "budget": 200000,
  "floor": null,
  "excluded_districts": ["–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥", "–ù–æ–≤–æ–∫–æ—Å–∏–Ω–æ", "–ú–∏—Ç–∏–Ω–æ", "–°–æ–ª–Ω—Ü–µ–≤–æ"],
  "excluded_floors": [],
  "priority": "location",
  "urgency": 5,
  "accessibility": null,
  "is_strict": true,
  "deal_type": "rent",
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –≤ —Ü–µ–Ω—Ç—Ä–µ"
{{
  "city": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
  "district": "–õ–µ–Ω–∏–Ω—Å–∫–∏–π",
  "district_operation": "replace",
  "area_m_min": null,
  "budget_maxin": null,
  "area_max": null,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "location",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null

–ó–∞–ø—Ä–æ—Å: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –Ω–∞ –∫—Ä–∞—é –≥–æ—Ä–æ–¥–∞"
{{
  "city": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
  "district": ["–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π", "–ß–∫–∞–ª–æ–≤—Å–∫–∏–π"],
  "district_operation": "replace",
  "area_min": null,
  "area_max": null,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –Ω–∞ –æ–∫—Ä–∞–∏–Ω–µ"
{{
  "city": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
  "district": ["–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π", "–ß–∫–∞–ª–æ–≤—Å–∫–∏–π"],
  "district_operation": "replace",
  "area_min": null,
  "area_max": null,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ú–æ—Å–∫–≤–∞, –æ–∫—Ä–∞–∏–Ω–Ω—ã–π —Ä–∞–π–æ–Ω"
{{
  "city": "–ú–æ—Å–∫–≤–∞",
  "district": ["–ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥", "–ù–æ–≤–æ–∫–æ—Å–∏–Ω–æ", "–ú–∏—Ç–∏–Ω–æ", "–°–æ–ª–Ω—Ü–µ–≤–æ"],
  "district_operation": "replace",
  "area_min": null,
  "area_max": null,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ò—â—É –¥–æ 150 —Ç—ã—Å—è—á, –≥–ª–∞–≤–Ω–æ–µ –Ω–µ –ø–µ—Ä–µ–ø–ª–∞—Ç–∏—Ç—å, —Ä–∞–π–æ–Ω –Ω–µ –≤–∞–∂–µ–Ω"
{{
  "city": null,
  "district": null,
  "district_operation": "replace",
  "area_min": null,
  "area_max": null,
  "budget": 150000,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "price",
  "urgency": 3,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ï—â—ë –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π –∏ –õ–µ–Ω–∏–Ω—Å–∫–∏–π"
{{
  "city": null,
  "district": ["–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π", "–õ–µ–Ω–∏–Ω—Å–∫–∏–π"],
  "district_operation": "add",
  "area_min": null,
  "area_max": null,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ö–∏—Ä–æ–≤—Å–∫–∏–π –∏–ª–∏ –í–µ—Ä—Ö-–ò—Å–µ—Ç—Å–∫–∏–π —Ä–∞–π–æ–Ω"
{{
  "city": null,
  "district": ["–ö–∏—Ä–æ–≤—Å–∫–∏–π", "–í–µ—Ä—Ö-–ò—Å–µ—Ç—Å–∫–∏–π"],
  "district_operation": "replace",
  "area_min": null,
  "area_max": null,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ü–æ–º–µ—â–µ–Ω–∏–µ 1000 –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –º–µ—Ç—Ä–æ–≤ –≤ –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ"
{{
  "city": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
  "district": null,
  "district_operation": "replace",
  "area_min": 800,
  "area_max": 1200,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ù—É–∂–Ω–∞ –ø–ª–æ—â–∞–¥—å 500 –º¬≤, –±—é–¥–∂–µ—Ç 300 —Ç—ã—Å"
{{
  "city": null,
  "district": null,
  "district_operation": "replace",
  "area_min": 400,
  "area_max": 600,
  "budget": 300000,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–ò—â–µ–º –æ—Ç 100 –¥–æ 200 –∫–≤–∞–¥—Ä–∞—Ç–æ–≤, –º–æ–∂–Ω–æ –õ–µ–Ω–∏–Ω—Å–∫–∏–π –∏–ª–∏ –ö–∏—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω"
{{
  "city": null,
  "district": ["–õ–µ–Ω–∏–Ω—Å–∫–∏–π", "–ö–∏—Ä–æ–≤—Å–∫–∏–π"],
  "district_operation": "replace",
  "area_min": 100,
  "area_max": 200,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "balanced",
  "urgency": 5,
  "accessibility": null,
  "is_strict": false,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–ó–∞–ø—Ä–æ—Å: "–°—Ç—Ä–æ–≥–æ 100 –º–µ—Ç—Ä–æ–≤, –Ω–µ –±–æ–ª—å—à–µ –∏ –Ω–µ –º–µ–Ω—å—à–µ"
{{
  "city": null,
  "district": null,
  "district_operation": "replace",
  "area_min": 98,
  "area_max": 102,
  "budget": null,
  "floor": null,
  "excluded_districts": [],
  "excluded_floors": [],
  "priority": "area",
  "urgency": 5,
  "accessibility": null,
  "is_strict": true,
  "deal_type": null,
  "renovation_status": null,
  "parking": null,
  "entrance_type": null
}}

–¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç–∞–π –∑–∞–ø—Ä–æ—Å –≤—ã—à–µ. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON."""

            messages = [
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": user_content
                }
            ]
            
            # Retry-–ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
            max_retries = 3
            retry_delay = 1  # —Å–µ–∫—É–Ω–¥—ã
            
            for attempt in range(max_retries):
                try:
                    loop = asyncio.get_event_loop()
                    response = await loop.run_in_executor(
                        None,
                        lambda: self.giga.chat({
                            "messages": messages,
                            "max_tokens": GIGACHAT_MAX_TOKENS_SEARCH
                        })
                    )
                    break  # –£—Å–ø–µ—à–Ω–æ - –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ retry
                    
                except Exception as retry_error:
                    error_msg = str(retry_error)
                    # SSL –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
                    if any(err in error_msg for err in ["SSL", "EOF", "Connection", "Timeout"]):
                        if attempt < max_retries - 1:
                            print(f"‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –Ω–µ —É–¥–∞–ª–∞—Å—å: {error_msg[:100]}...")
                            print(f"‚è≥ –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {retry_delay} —Å–µ–∫...")
                            await asyncio.sleep(retry_delay)
                            retry_delay *= 2  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                            continue
                    # –ï—Å–ª–∏ –Ω–µ SSL –æ—à–∏–±–∫–∞ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                    raise
            
            response_text = response.choices[0].message.content.strip()
            
            # –û—á–∏—Å—Ç–∫–∞ –æ—Ç markdown —Ä–∞–∑–º–µ—Ç–∫–∏ (```json ... ```)
            if "```" in response_text:
                parts = response_text.split("```")
                if len(parts) >= 3:
                    response_text = parts[1]
                    if response_text.startswith("json"):
                        response_text = response_text[4:]
            
            # –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ JSON –æ–±—ä–µ–∫—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç
            json_match = re.search(r'\{.*\}', response_text, re.DOTALL)
            if json_match:
                response_text = json_match.group()
            
            params = json.loads(response_text)
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if params.get("is_strict"):
                print(f"üîí –°–¢–†–û–ì–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø: {params.get('priority', 'balanced')} –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç")
            if params.get("excluded_districts"):
                print(f"üö´ –ò–°–ö–õ–Æ–ß–ï–ù–´ –†–ê–ô–û–ù–´: {params.get('excluded_districts')}")
            if params.get("urgency", 0) > 7:
                print(f"‚ö° –°–†–û–ß–ù–´–ô –ó–ê–ü–†–û–°: urgency={params.get('urgency')}")
            
            # –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ mapping –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤
            city_lower = params.get("city", "").lower() if params.get("city") else ""
            district = params.get("district")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º district - –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, —Å–ø–∏—Å–∫–æ–º –∏–ª–∏ None
            if district:
                if isinstance(district, list):
                    # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è mapping
                    district_lower = district[0].lower() if district else ""
                elif isinstance(district, str):
                    district_lower = district.lower()
                else:
                    district_lower = ""
            else:
                district_lower = ""
            
            # –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–∞–º —Ä–∞–π–æ–Ω –∏ –µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            if city_lower in DISTRICT_MAPPING and district_lower:
                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å —Ä–∞–π–æ–Ω–∞–º–∏
                for category, districts in DISTRICT_MAPPING[city_lower].items():
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ä–∞–π–æ–Ω –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–π–æ–Ω–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    for mapped_district in districts:
                        if district_lower in mapped_district.lower() or mapped_district.lower() in district_lower:
                            # –ù–∞–π–¥–µ–Ω–æ –ø—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                            if not isinstance(params.get("district"), list):
                                params["district"] = mapped_district
                                print(f"üìç –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ '{district_lower}' ‚Üí {mapped_district}")
                            break
                    else:
                        continue
                    break
            
            return params
                
        except Exception as e:
            error_msg = str(e)
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: {error_msg}")
            
            # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
            if "400" in error_msg and "Authorization" in error_msg:
                print("‚ö†Ô∏è –ü–†–ò–ß–ò–ù–ê: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç GIGACHAT_CREDENTIALS. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ apis.env.")
            elif "SSL" in error_msg or "EOF" in error_msg:
                print("‚ö†Ô∏è –ü–†–ò–ß–ò–ù–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å SSL-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º –∫ GigaChat API.")
                print("üí° –†–ï–®–ï–ù–ò–ï: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å–Ω–æ–≤–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.")
            elif "Connection" in error_msg or "Timeout" in error_msg:
                print("‚ö†Ô∏è –ü–†–ò–ß–ò–ù–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ GigaChat API.")
                print("üí° –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.")
            
            return {}

    async def validate_search_criteria(self, criteria: dict) -> dict:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ–∏—Å–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è).
        
        Args:
            criteria: –°–ª–æ–≤–∞—Ä—å —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –ø–æ–∏—Å–∫–∞
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: 
            {
                "is_valid": bool,
                "is_realistic": bool,
                "warnings": [—Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π],
                "suggestions": [—Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π],
                "conflicting_params": [–∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã]
            }
        """
        validation = {
            "is_valid": True,
            "is_realistic": True,
            "warnings": [],
            "suggestions": [],
            "conflicting_params": []
        }
        
        city = criteria.get("city", "").lower() if criteria.get("city") else ""
        district = criteria.get("district", "").lower() if criteria.get("district") else ""
        budget = criteria.get("budget")
        priority = criteria.get("priority", "balanced")
        is_strict = criteria.get("is_strict", False)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ù–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –±—é–¥–∂–µ—Ç –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞
        if "—Ü–µ–Ω—Ç—Ä" in district and budget and budget < 100000:
            validation["is_realistic"] = False
            validation["warnings"].append(
                f"‚ö†Ô∏è –í —Ü–µ–Ω—Ç—Ä–µ –ø–æ–º–µ—â–µ–Ω–∏—è –æ–±—ã—á–Ω–æ –æ—Ç 150 000 —Ä—É–±/–º–µ—Å. –ë—é–¥–∂–µ—Ç {budget} —Ä—É–± –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º."
            )
            validation["suggestions"].append(
                "üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –¥–æ 150 000+ –∏–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ —Ä–∞–π–æ–Ω—ã"
            )
            validation["conflicting_params"].append(("district", "budget"))
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ú–æ—Å–∫–≤–∞-—Ü–µ–Ω—Ç—Ä —Å –æ—á–µ–Ω—å —Å—Ç—Ä–æ–≥–∏–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∏ –Ω–∏–∑–∫–∏–º –±—é–¥–∂–µ—Ç–æ–º
        if city == "–º–æ—Å–∫–≤–∞" and "—Ü–µ–Ω—Ç—Ä" in district and is_strict and budget and budget < 150000:
            validation["is_realistic"] = False
            validation["warnings"].append(
                "üö® –ö–†–ò–¢–ò–ß–ù–û: –°—Ç—Ä–æ–≥–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ '—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã' + –±—é–¥–∂–µ—Ç < 150–∫ - –ø–æ—á—Ç–∏ –Ω–µ–≤—ã–ø–æ–ª–Ω–∏–º–æ"
            )
            validation["suggestions"].append(
                "üí° –°–ø—Ä–æ—Å–∏—Ç–µ: '–£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –¥–æ 200–∫ –∏–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–π–æ–Ω—ã —Ä—è–¥–æ–º —Å —Ü–µ–Ω—Ç—Ä–æ–º?'"
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –≤ –ø–ª–æ—â–∞–¥–∏
        area_min = criteria.get("area_min")
        area_max = criteria.get("area_max")
        if area_min and area_max and area_min > area_max:
            validation["is_valid"] = False
            validation["warnings"].append(
                f"‚ùå –û–®–ò–ë–ö–ê: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å ({area_min}) –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π ({area_max})"
            )
            validation["suggestions"].append(
                "üí° –£—Ç–æ—á–Ω–∏—Ç–µ –ø–ª–æ—â–∞–¥—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
            )
            validation["conflicting_params"].append(("area_min", "area_max"))
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç "price" —Å–æ —Å—Ç—Ä–æ–≥–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º location
        if priority == "price" and is_strict and district:
            validation["warnings"].append(
                "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤: '–≥–ª–∞–≤–Ω–æ–µ —Ü–µ–Ω–∞' + '—Ç–æ–ª—å–∫–æ —Ü–µ–Ω—Ç—Ä' - –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–∏—Å–∫–æ–º"
            )
            validation["suggestions"].append(
                "üí° –£—Ç–æ—á–Ω–∏—Ç–µ: —á—Ç–æ –≤–∞–∂–Ω–µ–µ - —Ü–µ–Ω–∞ –∏–ª–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ?"
            )
            validation["conflicting_params"].append(("priority", "district"))
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –û—á–µ–Ω—å —É–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–ª–æ—â–∞–¥–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–æ–π)
        if area_min and area_max and (area_max - area_min) < 10:
            validation["warnings"].append(
                f"‚ÑπÔ∏è –û—á–µ–Ω—å —É–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –ø–ª–æ—â–∞–¥–∏: {area_min}-{area_max} –º¬≤ (–≤—Å–µ–≥–æ {area_max - area_min} –º¬≤)"
            )
            if not is_strict:
                validation["suggestions"].append(
                    "üí° –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –ø–ª–æ—â–∞–¥–∏ –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –≤—ã–±–æ—Ä–∞"
                )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ 6: –ò—Å–∫–ª—é—á–µ–Ω—ã –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞–π–æ–Ω—ã
        excluded_districts = criteria.get("excluded_districts", [])
        if len(excluded_districts) > 5:
            validation["warnings"].append(
                f"‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω–æ –º–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–æ–≤ ({len(excluded_districts)}). –≠—Ç–æ –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã–±–æ—Ä."
            )
        
        return validation
    
    async def generate_response(self, user_message: str, context: Optional[list] = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç GigaChat –º–æ–¥–µ–ª–∏
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞)
        
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç –ò–ò –º–æ–¥–µ–ª–∏
        """
        if not self.gigachat_available:
            return "‚ùå –ò–ò –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ GIGACHAT_CREDENTIALS –≤ .env —Ñ–∞–π–ª–µ."
        
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
            messages = []
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            messages.append({
                "role": "system",
                "content": "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ Telegram –±–æ—Ç–µ. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É."
            })
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å
            if context:
                messages.extend(context)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            messages.append({
                "role": "user",
                "content": user_message
            })
            
            # –í—ã–∑—ã–≤–∞–µ–º GigaChat API (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.giga.chat({
                    "messages": messages,
                    "max_tokens": GIGACHAT_MAX_TOKENS_RESPONSE
                })
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GigaChat: {str(e)}"
    
    async def analyze_listings(self, criteria: dict, listings: List[Dict], dislike_reason: str = None, budget_exceeded: bool = False, area_exceeded: bool = False) -> List[Dict]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ —Ä–∞–Ω–∂–∏—Ä—É–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º –í–°–ï–• –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤,
        –¥–∏–∑–ª–∞–π–∫–æ–≤ –∏ –∂—ë—Å—Ç–∫–æ—Å—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.
        
        Args:
            criteria: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ (–≤–∫–ª—é—á–∞—è priority, is_strict, excluded_*, urgency)
            listings: –°–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –æ—Ç –ø–∞—Ä—Å–µ—Ä–∞
            dislike_reason: –ü—Ä–∏—á–∏–Ω–∞ –¥–∏–∑–ª–∞–π–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            budget_exceeded: –§–ª–∞–≥ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞
            area_exceeded: –§–ª–∞–≥ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–ª–æ—â–∞–¥–∏
        
        Returns:
            –°–ø–∏—Å–æ–∫ –æ—Ç—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å AI-–æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
        """
        if not self.gigachat_available:
            return []
        
        if not listings:
            return []
        
        try:
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
            system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—é –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø–æ–º–µ—â–µ–Ω–∏–π –¥–ª—è –æ—Ñ–∏—Å–∞ –±–∞–Ω–∫–∞.

–ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–ê–í–ò–õ–ê –†–ê–ù–ñ–ò–†–û–í–ê–ù–ò–Ø:

1. –ì–ï–û–ì–†–ê–§–ò–Ø (–µ—Å–ª–∏ is_strict: true):
   - –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–π–æ–Ω - –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ù–ï –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–π–æ–Ω–∞ ‚Üí –æ—Ü–µ–Ω–∫–∞ 0/10 –∏–ª–∏ –ü–û–õ–ù–û–ï –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï
   - –ï—Å–ª–∏ —Ä–∞–π–æ–Ω –≤ excluded_districts ‚Üí –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ö–õ–Æ–ß–ò–¢–¨ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - "—Ü–µ–Ω—Ç—Ä" = –ñ–Å–°–¢–ö–û–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ, –ù–ï –∫–æ–º–ø—Ä–æ–º–∏—Å—Å

2. –ü–†–ò–û–†–ò–¢–ï–¢–´ (priority):
   - "location": –î–æ–ø—É—Å—Ç–∏–º–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –¥–æ 30% –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞
   - "price": –°–¢–†–û–ì–û –≤ –±—é–¥–∂–µ—Ç–µ, –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ = –æ—Ü–µ–Ω–∫–∞ 0/10
   - "area": –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º —Å –ø–ª–æ—â–∞–¥—å—é >= —Ç—Ä–µ–±—É–µ–º–æ–π
   - "balanced": –ë–∞–ª–∞–Ω—Å 50/50 –º–µ–∂–¥—É –≤—Å–µ–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

3. –£–ß–Å–¢ –î–ò–ó–õ–ê–ô–ö–û–í:
   - "–¥–∞–ª–µ–∫–æ –æ—Ç –º–µ—Ç—Ä–æ" ‚Üí +50% –≤–µ—Å–∞ –¥–ª—è accessibility, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º —É –º–µ—Ç—Ä–æ
   - "–¥–æ—Ä–æ–≥–æ" ‚Üí —Å–Ω–∏–∑–∏—Ç—å –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –¥–æ 10%
   - "–º–∞–ª–µ–Ω—å–∫–∞—è –ø–ª–æ—â–∞–¥—å" ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º —Å area –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
   - "—à—É–º–Ω–æ" ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–µ—Ä—Ö–Ω–∏–º —ç—Ç–∞–∂–∞–º, –±–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä–∞–º

4. –ò–°–ö–õ–Æ–ß–ï–ù–ò–Ø (–ö–†–ò–¢–ò–ß–ù–û):
   - –ï—Å–ª–∏ floor –≤ excluded_floors ‚Üí –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ö–õ–Æ–ß–ò–¢–¨
   - –ï—Å–ª–∏ district –≤ excluded_districts ‚Üí –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ö–õ–Æ–ß–ò–¢–¨
   - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –æ—Ç–≤–µ—Ä–≥

5. –°–†–û–ß–ù–û–°–¢–¨ (urgency > 7):
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º "–≥–æ—Ç–æ–≤–æ –∫ –∑–∞—Å–µ–ª–µ–Ω–∏—é"
   - –ü–æ–≤—ã—Å–∏—Ç—å –≤–µ—Å "–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Ä–∞–∑—É"
   - –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞

6. –§–û–†–ú–ê–¢ –û–ë–™–Ø–°–ù–ï–ù–ò–Ø (ai_reason):
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑–∞—Ç—å, –ü–û–ß–ï–ú–£ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–∞ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
   - –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –±—é–¥–∂–µ—Ç: "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–∞–µ—Ç –±—é–¥–∂–µ—Ç –Ω–∞ X —Ä—É–±, –Ω–æ –æ—Ç–ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç—Ä–µ"
   - –ï—Å–ª–∏ –Ω–µ –≤ —Ç—Ä–µ–±—É–µ–º–æ–º —Ä–∞–π–æ–Ω–µ: "–ù–µ –≤ —Ü–µ–Ω—Ç—Ä–µ, –Ω–æ 3 –º–∏–Ω –¥–æ –º–µ—Ç—Ä–æ + –ø–∞—Ä–∫–æ–≤–∫–∞"
   - –ú–∞–∫—Å–∏–º—É–º 150 —Å–∏–º–≤–æ–ª–æ–≤, –ö–û–ù–ö–†–ï–¢–ù–û –∏ –ü–û –î–ï–õ–£
   - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "—Ö–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç"

–§–û–†–ú–£–õ–ê –û–¶–ï–ù–ö–ò (–ø—Ä–∏–º–µ—Ä):
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—è (is_strict): 0-50 –±–∞–ª–ª–æ–≤ (0 –µ—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä–æ–≥–æ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é)
- –ë—é–¥–∂–µ—Ç (priority="price"): 0-30 –±–∞–ª–ª–æ–≤ (0 –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–∏ price-priority)
- –ü–ª–æ—â–∞–¥—å: 0-20 –±–∞–ª–ª–æ–≤
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–ø–æ—Å–ª–µ –¥–∏–∑–ª–∞–π–∫–∞): 0-25 –±–∞–ª–ª–æ–≤
- –°—Ä–æ—á–Ω–æ—Å—Ç—å (–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å): 0-20 –±–∞–ª–ª–æ–≤

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: –¢–û–õ–¨–ö–û JSON-–º–∞—Å—Å–∏–≤, –ë–ï–ó –¢–ï–ö–°–¢–ê."""

            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—Ä–∏—Ç–µ—Ä–∏—è—Ö
            criteria_details = []
            criteria_details.append(f"–ì–æ—Ä–æ–¥: {criteria.get('city', '–Ω–µ —É–∫–∞–∑–∞–Ω')}")
            
            if criteria.get('district'):
                strict_marker = " [–°–¢–†–û–ì–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï]" if criteria.get('is_strict') else ""
                criteria_details.append(f"–†–∞–π–æ–Ω: {criteria.get('district')}{strict_marker}")
            
            if criteria.get('area_min') or criteria.get('area_max'):
                area_str = ""
                if criteria.get('area_min') and criteria.get('area_max'):
                    area_str = f"{criteria.get('area_min')}-{criteria.get('area_max')} –º¬≤"
                elif criteria.get('area_min'):
                    area_str = f"–æ—Ç {criteria.get('area_min')} –º¬≤"
                elif criteria.get('area_max'):
                    area_str = f"–¥–æ {criteria.get('area_max')} –º¬≤"
                criteria_details.append(f"–ü–ª–æ—â–∞–¥—å: {area_str}")
            
            if criteria.get('budget'):
                criteria_details.append(f"–ë—é–¥–∂–µ—Ç: –¥–æ {criteria.get('budget')} —Ä—É–±/–º–µ—Å")
            
            if criteria.get('excluded_districts'):
                criteria_details.append(f"üö´ –ò–°–ö–õ–Æ–ß–ï–ù–´ –†–ê–ô–û–ù–´: {', '.join(criteria.get('excluded_districts'))}")
            
            if criteria.get('excluded_floors'):
                criteria_details.append(f"üö´ –ò–°–ö–õ–Æ–ß–ï–ù–´ –≠–¢–ê–ñ–ò: {', '.join(map(str, criteria.get('excluded_floors')))}")
            
            priority = criteria.get('priority', 'balanced')
            urgency = criteria.get('urgency', 5)
            
            criteria_details.append(f"\nüéØ –ü–†–ò–û–†–ò–¢–ï–¢: {priority}")
            criteria_details.append(f"‚ö° –°–†–û–ß–ù–û–°–¢–¨: {urgency}/10")
            
            if criteria.get('accessibility'):
                criteria_details.append(f"üöá –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: {criteria.get('accessibility')}")
            
            criteria_text = "\n".join(criteria_details)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –Ω–æ–º–µ—Ä–∞–º–∏
            listings_json = "\n".join([
                f"{i+1}. [ID:{l.get('id', i+1)}] –ê–¥—Ä–µ—Å: {l.get('address', '–Ω–µ —É–∫–∞–∑–∞–Ω')}, "
                f"–†–∞–π–æ–Ω: {l.get('district', '–Ω–µ —É–∫–∞–∑–∞–Ω')}, "
                f"–ü–ª–æ—â–∞–¥—å: {l.get('area', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}–º¬≤, "
                f"–¶–µ–Ω–∞: {l.get('price', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')} —Ä—É–±/–º–µ—Å, "
                f"–≠—Ç–∞–∂: {l.get('floor', '–Ω–µ —É–∫–∞–∑–∞–Ω')}, "
                f"–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: {l.get('accessibility', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}"
                for i, l in enumerate(listings)
            ])
            
            # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∑–ª–∞–π–∫–∞
            dislike_context = ""
            if dislike_reason:
                dislike_context = f"""

üî¥ –ö–†–ò–¢–ò–ß–ù–û - –£–ß–¢–ò –ü–†–ï–î–´–î–£–©–ò–ô –î–ò–ó–õ–ê–ô–ö:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—á–∏–Ω–µ: "{dislike_reason}"

–î–ï–ô–°–¢–í–ò–Ø:
- –ò–∑–±–µ–≥–∞–π –ø–æ–º–µ—â–µ–Ω–∏–π —Å –ø–æ—Ö–æ–∂–∏–º–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞–º–∏
- –ü–æ–≤—ã—Å—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞—é—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É
- –í ai_reason –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏, –∫–∞–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∏–∑ –¥–∏–∑–ª–∞–π–∫–∞
"""
            
            # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
            criteria_warning = ""
            if budget_exceeded or area_exceeded:
                warnings = []
                if budget_exceeded and criteria.get("budget"):
                    if priority == "price":
                        warnings.append("‚ö†Ô∏è –°–¢–†–û–ì–ò–ô –ë–Æ–î–ñ–ï–¢: –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ù–ï–î–û–ü–£–°–¢–ò–ú–û")
                    else:
                        warnings.append(f"‚ö†Ô∏è –ë—é–¥–∂–µ—Ç –¥–æ {criteria.get('budget')} —Ä—É–± (–¥–æ–ø—É—Å—Ç–∏–º–æ +20-30% –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è)")
                
                if area_exceeded:
                    warnings.append("‚ö†Ô∏è –ü–ª–æ—â–∞–¥—å: —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ª—É—á—à–µ")
                
                criteria_warning = f"""

‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï - –ù–ï–ö–û–¢–û–†–´–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø –ù–ï –í –¢–û–ß–ù–û–°–¢–ò –°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–¢ –ö–†–ò–¢–ï–†–ò–Ø–ú:
{chr(10).join(warnings)}

–†–∞–Ω–∂–∏—Ä—É–π –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É: —á–µ–º –±–ª–∏–∂–µ –∫ –∫—Ä–∏—Ç–µ—Ä–∏—è–º, —Ç–µ–º –≤—ã—à–µ –ø–æ–∑–∏—Ü–∏—è.
"""
            
            user_content = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –æ—Ç—Ä–∞–Ω–∂–∏—Ä—É–π –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ñ–∏—Å–∞ –±–∞–Ω–∫–∞ (—Ä–∞–±–æ—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤).

–ö–†–ò–¢–ï–†–ò–ò –ö–õ–ò–ï–ù–¢–ê:
{criteria_text}{dislike_context}{criteria_warning}

–î–û–°–¢–£–ü–ù–´–ï –û–ë–™–Ø–í–õ–ï–ù–ò–Ø:
{listings_json}

–ó–ê–î–ê–ß–ê:
1. –ò–°–ö–õ–Æ–ß–ò –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ excluded_districts –∏ excluded_floors (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
2. –û—Ç—Ä–∞–Ω–∂–∏—Ä—É–π –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ –æ—Ü–µ–Ω–∫–∏ (—Å–º. —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
3. –î–ª—è –ö–ê–ñ–î–û–ì–û –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞–ø–∏—à–∏ –ö–û–ù–ö–†–ï–¢–ù–û–ï –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (ai_reason)

–í–ê–ñ–ù–û –î–õ–Ø –û–§–ò–°–ê –ë–ê–ù–ö–ê:
- –î–µ–ª–æ–≤–æ–π —Ä–∞–π–æ–Ω / –±–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä > —Ç–æ—Ä–≥–æ–≤—ã–µ –∑–æ–Ω—ã
- –≠—Ç–∞–∂–∏ 2-5 > –ø–µ—Ä–≤—ã–π —ç—Ç–∞–∂ (—Ç–∏—à–µ, —Å–ø–æ–∫–æ–π–Ω–µ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã)
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–º–µ—Ç—Ä–æ, –ø–∞—Ä–∫–æ–≤–∫–∞)
- –¢—Ä–∞—Ñ–∏–∫ –ù–ï –≤–∞–∂–µ–Ω (—ç—Ç–æ –æ—Ñ–∏—Å, –∞ –Ω–µ –æ—Ç–¥–µ–ª–µ–Ω–∏–µ)

–í–µ—Ä–Ω–∏ JSON-–º–∞—Å—Å–∏–≤ (–æ—Ç –ª—É—á—à–µ–≥–æ –∫ —Ö—É–¥—à–µ–º—É):
[
  {{
    "id": –Ω–æ–º–µ—Ä_–∏–∑_—Å–ø–∏—Å–∫–∞_–≤—ã—à–µ,
    "reason": "–ö–û–ù–ö–†–ï–¢–ù–û–ï –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (–ø–æ—á–µ–º—É –Ω–∞ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏, —á—Ç–æ —Ö–æ—Ä–æ—à–æ/–ø–ª–æ—Ö–æ, —Ü–∏—Ñ—Ä—ã)"
  }},
  ...
]

–í–∫–ª—é—á–∏ –í–°–ï –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–∫—Ä–æ–º–µ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö). –¢–û–õ–¨–ö–û JSON."""

            messages = [
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": user_content
                }
            ]
            
            # –í—ã–∑—ã–≤–∞–µ–º GigaChat API
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.giga.chat({
                    "messages": messages,
                    "max_tokens": GIGACHAT_MAX_TOKENS_ANALYSIS
                })
            )
            
            response_text = response.choices[0].message.content
            
            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            json_match = re.search(r'\[.*\]', response_text, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
            else:
                result = json.loads(response_text)
            
            # –°–æ–∑–¥–∞–µ–º –æ—Ç—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
            ranked_listings = []
            processed_ids = set()
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ò–ò
            for rank, item in enumerate(result, 1):
                listing_id = item.get('id')
                reason = item.get('reason', '')
                
                # –ù–∞—Ö–æ–¥–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ ID
                listing = next((l for idx, l in enumerate(listings) if idx + 1 == listing_id), None)
                if listing:
                    listing_with_reason = listing.copy()
                    listing_with_reason['ai_reason'] = reason
                    listing_with_reason['ai_rank'] = rank
                    ranked_listings.append(listing_with_reason)
                    processed_ids.add(listing_id)
                    
                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    if rank <= 3:
                        print(f"üèÜ #{rank}: {listing.get('address', 'N/A')} - {reason[:80]}...")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –∫–æ–Ω–µ—Ü
            for idx, listing in enumerate(listings, 1):
                if idx not in processed_ids:
                    listing_copy = listing.copy()
                    listing_copy['ai_reason'] = ""  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –ò–ò –Ω–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª
                    listing_copy['ai_rank'] = len(ranked_listings) + 1
                    ranked_listings.append(listing_copy)
            
            return ranked_listings
            
        except json.JSONDecodeError as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç GigaChat: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞
            return [dict(l, ai_reason="", ai_rank=i+1) for i, l in enumerate(listings)]
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: {e}")
            return [dict(l, ai_reason="", ai_rank=i+1) for i, l in enumerate(listings)]

    async def generate_search_alternatives(self, criteria: Dict, analysis: str = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
        """
        if not self.gigachat_available:
            return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞."

        # –§–∏–ª—å—Ç—Ä—É–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞–Ω–Ω—ã–µ
        active_criteria = {k: v for k, v in criteria.items() if v is not None}

        prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–∫–∞–ª –ø–æ–º–µ—â–µ–Ω–∏–µ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–µ–ª:
{json.dumps(active_criteria, ensure_ascii=False, indent=2)}

"""
        if analysis:
            prompt += f"""–ê–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞–∑–∞–ª —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
{analysis}

"""

        prompt += """–ü—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.
–í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û: –ü—Ä–µ–¥–ª–∞–≥–∞–π –∏–∑–º–µ–Ω–∏—Ç—å –¢–û–õ–¨–ö–û —Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ "–ê–Ω–∞–ª–∏–∑–µ –ø—Ä–∏—á–∏–Ω" –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ.
–ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–ª–æ—â–∞–¥—å, —Ä–∞–π–æ–Ω –∏ —Ç.–¥.), –µ—Å–ª–∏ –ø—Ä–æ –Ω–∏—Ö –Ω–µ —Å–∫–∞–∑–∞–Ω–æ –≤ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–∏—á–∏–Ω.
–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ –±—é–¥–∂–µ—Ç–µ - –¥–∞–π —Å–æ–≤–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –±—é–¥–∂–µ—Ç—É.
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–ø–∏—Å–∫–∞ —Å –∫—Ä–∞—Ç–∫–∏–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown —Ä–∞–∑–º–µ—Ç–∫—É, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç."""

        try:
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.giga.chat({
                    "messages": [{"role": "user", "content": prompt}],
                    "max_tokens": 500
                })
            )
            return response.choices[0].message.content
        except Exception as e:
            print(f"Error generating alternatives: {e}")
            return "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω –∏–ª–∏ –ø–ª–æ—â–∞–¥–∏."

    async def compare_listings(self, listings: List[Dict]) -> str:
        """
        –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É/—Ç–µ–∫—Å—Ç.
        """
        if not self.gigachat_available:
            return "–°–µ—Ä–≤–∏—Å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."

        listings_text = ""
        for i, l in enumerate(listings, 1):
            listings_text += f"–û–±—ä—è–≤–ª–µ–Ω–∏–µ #{i}:\n"
            listings_text += f"–ê–¥—Ä–µ—Å: {l.get('address')}\n"
            listings_text += f"–¶–µ–Ω–∞: {l.get('price')} —Ä—É–±.\n"
            listings_text += f"–ü–ª–æ—â–∞–¥—å: {l.get('area')} –º2\n"
            listings_text += f"–û–ø–∏—Å–∞–Ω–∏–µ: {l.get('description')}\n\n"

        prompt = f"""–°—Ä–∞–≤–Ω–∏ —Å–ª–µ–¥—É—é—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–º–µ—â–µ–Ω–∏–π –∏ —Å–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫—É—é —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (—Ç–µ–∫—Å—Ç–æ–≤—É—é) —Å –ø–ª—é—Å–∞–º–∏ –∏ –º–∏–Ω—É—Å–∞–º–∏ –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞.
–í –∫–æ–Ω—Ü–µ —Å–¥–µ–ª–∞–π –≤—ã–≤–æ–¥, –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ü–µ–ª–∏.

{listings_text}"""

        try:
            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: self.giga.chat({
                    "messages": [{"role": "user", "content": prompt}],
                    "max_tokens": 1000
                })
            )
            return response.choices[0].message.content
        except Exception as e:
            print(f"Error comparing listings: {e}")
            return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ä–∞–≤–Ω–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è."
    
    async def generate_image(self, prompt: str) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ GigaChat (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        
        Args:
            prompt: –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        
        Returns:
            URL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        # GigaChat –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞–ø—Ä—è–º—É—é
        # –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
        return None
    
    def is_available(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –ò–ò –º–æ–¥–µ–ª—å"""
        return self.gigachat_available


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
ai_service = AIService()
